<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTuber Plane Thing</title>
    <meta property="og:title" content="VTuber Plane Thing">
    <meta property="og:description" content="You're stuck on a flight with vtubers, where are you sitting?">
    <meta property="og:image" content="https://xoltia.github.io/vtuberplanething/thumbnail.png">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
        }

        div {
            margin-bottom: 10px;
        }

        label {
            display: inline-block;
            width: 200px;
        }

        input[type=" number"] {
            width: 50px;
        }

        select {
            width: 150px;
        }

        canvas {
            border: 1px solid black;
            margin-left:
                auto;
            margin-right: auto;
        }

        button {
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            border-radius: 3px;
            margin-top: 10px;
        }

        button#generate {
            color: white;
            background-color: rgb(44, 153, 44);
            border: none;
        }

        button#generate:hover {
            background-color: rgb(34, 133, 34);
        }

        button#save {
            color: white;
            background-color: rgb(78, 78, 235);
            border: none;
        }

        button#save:hover {
            background-color: rgb(61, 61, 212);
        }

        #controls {
            margin-bottom: 10px;
            height: 100%;
            background-color: #f0f0f0;
            padding: 10px;
        }

        @media (min-width: 768px) {
            body {
                flex-direction: row;
                justify-content: center;
                gap: 20px;
            }

            canvas {
                margin: 0;
            }
        }
    </style>
</head>

<body>
    <div id="controls">
        <div>
            <label for="rows">Rows:</label>
            <input type="number" id="rows" value="10">
        </div>
        <div>
            <label for="vacancyProbability">Vacancy Probability (%):</label>
            <input type="number" id="vacancyProbability" value="40" min="0" max="100">
        </div>
        <div>
            <label for="filterGender">Gender:</label>
            <select id="filterGender">
                <option value="Any">Any</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>
        <div>
            <label for="filterAgency">Agency:</label>
            <select id="filterAgency" multiple></select>
        </div>
        <!-- <input type="button" value="Generate" onclick="draw();"> -->
        <button id="generate" onclick="draw()">Generate</button>
        <button id="save" onclick="saveCanvas()">Save</button>
        </select>
    </div>
    <canvas id="canvas" width="450" height="1000"></canvas>
</body>
<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const cellSize = 50;
    const cols = width / cellSize;
    const vtubers = [];
    const sheets = {};
    let rows = height / cellSize;

    const filterAgency = document.getElementById('filterAgency');
    const rowsInput = document.getElementById('rows');

    rowsInput.value = rows;
    rowsInput.addEventListener('change', e => {
        rows = parseInt(e.target.value);
    });

    fetch('./vtubers-small.jsonl')
        .then(response => response.text())
        .then(text => {
            return text.split('\n').filter(Boolean).map(JSON.parse)
        })
        .then(data => {
            vtubers.push(...data);
            const agencies = {};
            vtubers.forEach(vtuber => {
                if (!agencies[vtuber.affiliation]) {
                    agencies[vtuber.affiliation] = 1;
                } else {
                    agencies[vtuber.affiliation]++;
                }
            });

            const sortedAgencies = Object.entries(agencies).sort((a, b) => b[1] - a[1]);
            sortedAgencies.forEach(([agency, count]) => {
                const option = document.createElement('option');
                option.value = agency;
                option.text = `${agency} (${count})`;
                option.selected = agency === 'hololive production';
                filterAgency.appendChild(option);
            });

            draw();
        });

    function shuffle(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function seatNumberToString(seatNumber) {
        const row = Math.floor(seatNumber / (cols - 2));
        const col = seatNumber % (cols - 2);
        const colLetter = String.fromCharCode('A'.charCodeAt(0) + col);
        return `${row + 1}${colLetter}`;
    }

    async function draw() {
        // update canvas size
        canvas.height = rows * cellSize;

        const selectedAgencies = Array.from(filterAgency.selectedOptions).map(option => option.value);
        const selectedGender = document.getElementById('filterGender').value;
        const vacancyProbability = parseInt(document.getElementById('vacancyProbability').value) / 100;
        console.log(selectedAgencies);
        let filtered = vtubers.filter(vtuber => {
            return selectedAgencies.includes(vtuber.affiliation) && (selectedGender === 'Any' || vtuber.gender === selectedGender);
        });
        filtered = shuffle(filtered);

        let seatNumber = -1;
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                const x = j * cellSize;
                const y = i * cellSize;

                if (j === 2 || j === 6) {
                    continue;
                }

                seatNumber++;

                const emptySeat = Math.random() < vacancyProbability || filtered.length === 0;
                if (emptySeat) {
                    ctx.fillStyle = 'gray';
                    ctx.fillRect(x, y, cellSize, cellSize);
                    ctx.fillStyle = 'black';
                    ctx.font = '20px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(seatNumberToString(seatNumber), x + cellSize / 2, y + cellSize / 2);
                    continue;
                }

                const v = filtered.pop();
                const img = await getImageFromSprite(v.image);
                ctx.drawImage(img, x, y, cellSize, cellSize);
            }
        }
    }

    async function getAffiliationSpriteSheet(spriteNumber) {
        if (sheets[spriteNumber]) {
            return sheets[spriteNumber];
        }
        const spriteSheet = await fetch(`./sprites/${spriteNumber}.png`);
        const blob = await spriteSheet.blob();
        const bitmap = createImageBitmap(blob);
        sheets[spriteNumber] = bitmap;
        return bitmap;
    }

    async function getImageFromSprite(imgId) {
        const [spriteNumber, spriteIndex] = imgId.split(':').map(Number);
        const spriteSheet = await getAffiliationSpriteSheet(spriteNumber);
        const dimension = spriteSheet.width / cellSize;
        const x = spriteIndex % dimension;
        const y = Math.floor(spriteIndex / dimension);

        return createImageBitmap(spriteSheet, x * cellSize, y * cellSize, cellSize, cellSize);
    }

    function saveCanvas() {
        const link = document.createElement('a');
        link.download = 'vtuber-plane.png';
        link.href = canvas.toDataURL();
        link.click();
    }
</script>

</html>