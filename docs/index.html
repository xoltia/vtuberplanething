<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTuber Plane Thing</title>
    <meta property="og:title" content="VTuber Plane Thing">
    <meta property="og:description" content="You're stuck on a flight with vtubers, where are you sitting?">
    <meta property="og:image" content="https://xoltia.github.io/vtuberplanething/assets/thumbnail.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans+Condensed&display=swap" rel="stylesheet">
    <link rel="preload" href="./sprites/0.png" as="image">
    <link rel="preload" href="./sprites/1.png" as="image">
    <link rel="preload" href="./sprites/2.png" as="image">
    <link rel="preload" href="./sprites/3.png" as="image">
    <style>
        body {
            font-family: 'Fira Sans Condensed', sans-serif;
            display: flex;
            flex-direction: column;
        }

        div {
            margin-bottom: 10px;
        }

        canvas {
            border: 1px solid black;
            margin-left: auto;
            margin-right: auto;
        }

        button {
            padding: 7px 10px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            border-radius: 3px;
            margin-top: 10px;
        }

        button#generate {
            color: white;
            background-color: rgb(44, 153, 44);
            border: none;
        }

        button#generate:hover {
            background-color: rgb(34, 133, 34);
        }

        button#save {
            color: white;
            background-color: rgb(78, 78, 235);
            border: none;
        }

        button#save:hover {
            background-color: rgb(61, 61, 212);
        }

        #controls {
            margin-bottom: 10px;
            height: 100%;
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
        }

        @media (min-width: 768px) {
            body {
                flex-direction: row;
                justify-content: center;
                align-items: start;
                gap: 20px;
            }

            canvas {
                margin: 0;
            }
        }

        #credit {
            margin-top: 15px;
            font-size: 12px;
            display: flex;
            justify-content: center;
        }

        #credit a {
            border-right: 1px solid black;
            padding-right: 10px;
        }

        #credit a:last-child {
            border-right: none;
            padding-right: 0;
        }

        #credit a {
            margin-right: 10px;
            text-decoration: none;
            color: black;
            display: flex;
            align-items: center;
        }

        #credit img {
            margin-right: 5px;
        }

        #credit a:last-child {
            margin-right: 0;
        }

        #credit a:hover {
            text-decoration: underline;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input {
            box-sizing: border-box;
        }

        input,
        select {
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="controls">
        <h1 style="font-size: 24px; margin-bottom: 12px; text-align: center;">
            VTuber Plane Thing
        </h1>
        <div>
            <label for="rows">Rows</label>
            <input type="number" id="rows" value="10">
        </div>
        <div>
            <label for="vacancyProbability">
                Vacancy Probability (%)
            </label>
            <input type="number" id="vacancyProbability" value="40" min="0" max="100" step="5">
        </div>
        <div>
            <label for="filterGender">Gender</label>
            <select id="filterGender">
                <option value="Any">Any</option>
                <option value="Female">Female</option>
                <option value="Male">Male</option>
            </select>
        </div>
        <div>
            <label for="filterAgency">Agency</label>
            <select id="filterAgency" multiple size="10"></select>
        </div>
        <button id="generate" onclick="draw()">Generate</button>
        <button id="save" onclick="saveCanvas()">Save</button>
        <div id="credit">
            <a href="https://github.com/xoltia/vtuberplanething" target="_blank">
                <img src="./assets/github.256x244.png" alt="GitHub" height="20">
                Source Code
            </a>
            <a href="https://hololist.net/" target="_blank">
                <img src="https://hololist.net/wp-content/themes/primary/assets/images/logo.png" alt="Hololive List"
                    height="20">
                Data Source
            </a>
        </div>
    </div>
    <canvas id="canvas" width="450"></canvas>
</body>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    let rows = urlParams.get('rows') ?? 20;

    if (urlParams.has('vacancyProbability')) {
        document.getElementById('vacancyProbability').value = urlParams.get('vacancyProbability');
    }

    const cellSize = 50;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const cols = canvas.width / cellSize;
    const vtubers = [];
    const sheets = {};

    const filterAgency = document.getElementById('filterAgency');
    const rowsInput = document.getElementById('rows');

    rowsInput.value = rows;
    rowsInput.addEventListener('change', e => {
        rows = parseInt(e.target.value);
    });

    fetch('./vtubers-small.json')
        .then(response => response.json())
        .then(data => {
            vtubers.push(...data);
            const agencies = {};
            vtubers.forEach(vtuber => {
                if (!agencies[vtuber.affiliation]) {
                    agencies[vtuber.affiliation] = 1;
                } else {
                    agencies[vtuber.affiliation]++;
                }
            });

            // Get initial agency from query string
            const initialAgency = urlParams.get('agency') ?? 'hololive production';
            console.log(initialAgency);
            const sortedAgencies = Object.entries(agencies).sort((a, b) => b[1] - a[1]);
            sortedAgencies.forEach(([agency, count]) => {
                const option = document.createElement('option');
                option.value = agency;
                option.text = `${agency} (${count})`;
                option.selected = agency === initialAgency;
                filterAgency.appendChild(option);
            });

            draw();
        });

    function shuffle(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function seatNumberToString(seatNumber) {
        const row = Math.floor(seatNumber / (cols - 2));
        const col = seatNumber % (cols - 2);
        const colLetter = String.fromCharCode('A'.charCodeAt(0) + col);
        return `${row + 1}${colLetter}`;
    }

    async function draw() {
        // update canvas size
        canvas.height = rows * cellSize;

        const selectedAgencies = Array.from(filterAgency.selectedOptions).map(option => option.value);
        const selectedGender = document.getElementById('filterGender').value;
        const vacancyProbability = parseInt(document.getElementById('vacancyProbability').value) / 100;
        let filtered = vtubers.filter(vtuber => {
            return selectedAgencies.includes(vtuber.affiliation) &&
                (selectedGender === 'Any' || vtuber.gender === selectedGender);
        });
        filtered = shuffle(filtered);

        let seatNumber = -1;
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                const x = j * cellSize;
                const y = i * cellSize;

                if (j === 2 || j === 6) {
                    continue;
                }

                seatNumber++;

                const emptySeat = Math.random() < vacancyProbability || filtered.length === 0;
                if (emptySeat) {
                    ctx.fillStyle = 'gray';
                    ctx.fillRect(x, y, cellSize, cellSize);
                    ctx.fillStyle = 'black';
                    ctx.font = '20px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(seatNumberToString(seatNumber), x + cellSize / 2, y + cellSize / 2);
                    continue;
                }

                const v = filtered.pop();
                const img = await getImageFromSprite(v.image);
                ctx.drawImage(img, x, y, cellSize, cellSize);
            }
        }
    }

    async function getAffiliationSpriteSheet(spriteNumber) {
        if (sheets[spriteNumber]) {
            return sheets[spriteNumber];
        }
        const spriteSheet = await fetch(`./sprites/${spriteNumber}.png`);
        const blob = await spriteSheet.blob();
        const bitmap = await createImageBitmap(blob);
        sheets[spriteNumber] = bitmap;
        return bitmap;
    }

    async function getImageFromSprite(imgId) {
        const [spriteNumber, spriteIndex] = imgId.split(':').map(Number);
        const spriteSheet = await getAffiliationSpriteSheet(spriteNumber);
        // const dimension = spriteSheet.width / cellSize;
        // const x = spriteIndex % dimension;
        // const y = Math.floor(spriteIndex / dimension);
        // return createImageBitmap(spriteSheet, x * cellSize, y * cellSize, cellSize, cellSize);
        return createImageBitmap(spriteSheet, cellSize * spriteIndex, 0, cellSize, cellSize);
    }

    function saveCanvas() {
        const link = document.createElement('a');
        link.download = 'vtuber-plane.png';
        link.href = canvas.toDataURL();
        link.click();
    }
</script>

</html>